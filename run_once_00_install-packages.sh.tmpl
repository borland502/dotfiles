#!/usr/bin/env bash

set -euo pipefail

# Script can be used with {{ .chezmoi.os }}, WSL (Windows), or MacOS with linuxbrew or homebrew.

  #shellcheck disable=SC1009,SC1050,SC1083,SC1054,SC1072,SC1073
  {{ if (ne .chezmoi.os "darwin") }}
#current session -- load path set by boostrap or current linuxbrew path
eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
  {{ end }}

# Update any existing homebrew recipes
brew update

echo "Preparing to install software on $OSTYPE"

# Lists of software to install

## essential foss stuff
essential_brew=(python3 golang p7zip fzf fd bat jq yq pyenv tldr starship vim rsync exa ripgrep)

echo "Installing minimal packages"
for i in ${essential_brew[@]}; do  
    brew install $i
done

echo "Installing misc plugins"
brew install pyenv-virtualenv
brew install pyenv-ccache

# execute the following only if this is an attended install (TTY present)
{{ if (eq .minimal "false") }}

echo "Installing the full course"

# Import decrypted env tokens if not already loaded, especially the Homebrew one
if [[ -z ${HOMEBREW_GITHUB_API_TOKEN+x} ]]; then
  export $(egrep -v '^#' .autoenv.zsh | xargs)
fi  

# Update Path to include helper binaries
export PATH="$PATH:$HOME/bin"

# Get installed brew packages
INSTALLED_PACKAGES=$(brew list)

echo "Adding custom taps"
brew tap AdoptOpenJDK/openjdk

echo "Installing all homebrew apps"

programming_languages_homebrew=(openjdk node typescript)

for i in ${programming_languages_homebrew[@]}; do
    brew install $i
done

build_tools_homebrew=(maven gradle npm)

for i in ${build_tools_homebrew[@]}; do
    brew install $i
done

cli_applications_homebrew=(nginx jenv diff-so-fancy prettyping shfmt autopep8 clang-format jenv nvm ncdu htop nmap gdrive gcalcli todo-txt subversion)

# terminator is not in a bottle on some flavors of linux
brew install --build-from-source terminator

for i in ${cli_applications_homebrew[@]}; do  
    brew install $i
done

  {{ if (eq .chezmoi.os "darwin") }}
# darwin
  echo "Installing all non-freeware packages with brew cask"

  gui_app_cask=(Vivaldi docker visual-studio-code slack discord dropbox intellij-idea adoptopenjdk8 1password-cli)
  gui_app_cask+=(iterm2 1password viscosity paw the-unarchiver macdown)
  for i in ${gui_app_cask[@]}; do
    brew install $i
  done
  {{ else if (eq .chezmoi.os "linux" ) }}
  #linux //TODO: detect X before installing the majority of these
  linux_gui_app_cask=(com.jetbrains.IntelliJ-IDEA-Ultimate com.visualstudio.code org.freedesktop.fwupd)

  for i in ${linux_gui_app_cask[@]}; do
    flatpak install -y --noninteractive $i
  done

    {{ if (.chezmoi.kernel.osrelease | lower | contains "microsoft")}}
  #WSL
  echo "WSL"
    {{ end }}
  {{ else }}
  # other operating system
  {{ end }}
{{ end }}