# chezmoi:template:left-delimiter="[[" right-delimiter=]]
version: "3"

vars:
  [[range .xdg -]]
  [[.]]
  [[end -]]
  [[range .taskfile -]]
  [[.]]
  [[end -]]
  RUN_PREFIX: "{{.POETRY}} run"
  VENV_PYTHON: "{{.RUN_PREFIX}} python"
  RUN_MODULE_PREFIX: "{{.RUN_PREFIX}} {{.PYTHON}} -m"
  DASBOOTSTRAP_PREFIX: "{{.RUN_MODULE_PREFIX}} dasbootstrap"

includes:
  ansible:
    optional: true
    taskfile: "{{.HOME}}/.ansible/Taskfile.yml"
  # global & bin represent the "production" project commands while others like chezmoi and dbs point to the development folders
  bin:
    taskfile: "{{.HOME}}/.local/bin/Taskfile.yml"
  chezmoi:
    optional: true
    taskfile: "{{.XDG_DATA_HOME}}/chezmoi/Taskfile.yaml"
  dbs:
    optional: true
    taskfile: "{{.XDG_DATA_HOME}}/automation/dasbootstrap/Taskfile.yml"
    dir: "{{.XDG_DATA_HOME}}/automation/dasbootstrap"

tasks:
  default:
    cmds:
      - |
        command -v brew >/dev/null || { echo "brew is mandatory for this to work, please install it"; exit 1; }
        command -v gum >/dev/null|| brew install gum
        selected=$(task --list-all | grep -v "task: Available" | grep -v "default:" | gum filter --indicator="->" --placeholder="Type to search for a task...")
        echo "$selected" | awk '{sub(/:$/, "", $2); print $2}' | xargs task

  tests:
    desc: "Run all unit, integration, and functional tests we have on various projects"
    cmds:
      - task: dbs:destroy:lxc
