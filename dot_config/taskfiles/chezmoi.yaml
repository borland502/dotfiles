# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  CHEZMOI_PREFIX: "{{.RUN_PREFIX}} chezmoi"
  VENV_PYTHON: "{{.RUN_PREFIX}} python"

tasks:
  default:
    cmds:
      - task -l

#  update:
#    desc: "Update chezmoi from github dotfiles"
#    interactive: true
#    cmds:
#      - "{{.CHEZMOI_PREFIX}} update"
#      - task: sync
#
  init:
    desc: "(re)Intialize chezmoi state from templates"
    interactive: true
    cmds:
      - "{{.CHEZMOI_PREFIX}} init"

  apply:
    desc: "Apply changes"
    interactive: true
    cmds:
#      - task: update
      - task: init
      - "{{.CHEZMOI_PREFIX}} apply"

  sync:
    desc: "Synchronize development dir with working chezmoi dir"
    ignore_error: true
    interactive: true
    preconditions:
      - sh: "command -v unison"
      - sh: "command -v rsync"
    cmds:
      - unison -batch -auto "${XDG_DATA_HOME}/automation/chezmoi" "${XDG_DATA_HOME}/chezmoi" 2> /dev/null
      - >-
        rsync -avzu --compress-choice="zstd" --delete --info=progress2 --no-whole-file 
        -h "${XDG_DATA_HOME}/automation/chezmoi/" "${XDG_DATA_HOME}/chezmoi"

#  predeploy:
#    desc: "Deploy chezmoi"
#    interactive: true
#    deps:
#      - task: apply
#    cmds:
#      - "{{.CHEZMOI_PREFIX}} git status"
