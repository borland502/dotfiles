# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  CHEZMOI_PREFIX: "chezmoi"

tasks:
  default:
    cmds:
      - task -l

  update:
    desc: "Update chezmoi from github dotfiles"
    cmds:
      - "{{.CHEZMOI_PREFIX}} update"
      - task: sync

  init:
    desc: "(re)Intialize chezmoi state from templates"
    cmds:
      - "{{.CHEZMOI_PREFIX}} init"

  apply:
    interactive: true
    desc: "Apply changes from downloaded dotfiles"
    cmds:
      - task: sync
      - task: update
      - task: init
      - "{{.CHEZMOI_PREFIX}} diff"
      - task: stash
      - "{{.CHEZMOI_PREFIX}} apply"
      - task: stash:pop
      - "source ~/.zshrc"

  stash:
    desc: "Stash chezmoi changes"
    cmds:
      - "git stash"

  stash:pop:
    desc: "Pop chezmoi stash"
    cmds:
      - "git stash pop"

  sync:
    desc: "Synchronize development dir with working chezmoi dir"
    preconditions:
      - sh: "has unison"
    cmd: unison -batch -auto "${XDG_DATA_HOME}/automation/chezmoi" "${XDG_DATA_HOME}/chezmoi"
    ignore_error: true

  predeploy:
    desc: "Deploy chezmoi"
    interactive: true
    deps:
      - task: apply
    cmds:
      - "{{.CHEZMOI_PREFIX}} git status"
